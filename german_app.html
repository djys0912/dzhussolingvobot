<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ò–∑—É—á–µ–Ω–∏–µ –Ω–µ–º–µ—Ü–∫–æ–≥–æ —è–∑—ã–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π –∏ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã, —É–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ --- */
        * {margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent;}
        body {background:#f2f2f7;color:#000;min-height:100vh;min-width:100vw;display:flex;flex-direction:column;overflow:hidden;}
        body.dark-theme {background:#000;color:#fff;}
        .header {background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(60,60,67,0.15);position:sticky;top:0;z-index:10;}
        .dark-theme .header {background:rgba(30,30,30,0.7);border-bottom:1px solid rgba(255,255,255,0.15);}
        .header h1 {font-size:17px;font-weight:600;text-align:center;flex:1;}
        .header-button {color:#007AFF;font-size:17px;font-weight:400;background:none;border:none;padding:0 8px;cursor:pointer;}
        .dark-theme .header-button {color:#0A84FF;}
        .container {flex:1;display:flex;flex-direction:column;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
        .word-card {background:#fff;border-radius:10px;padding:20px;margin-bottom:16px;box-shadow:0 1px 5px rgba(0,0,0,0.1);display:flex;flex-direction:column;align-items:center;animation:slide-up 0.3s;}
        .dark-theme .word-card {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
        .word {font-size:32px;font-weight:700;margin-bottom:8px;color:#000;}
        .dark-theme .word {color:#fff;}
        .progress-info {font-size:15px;color:#8E8E93;margin-bottom:16px;}
        .progress-bar-container {width:100%;height:8px;background:#E5E5EA;border-radius:4px;overflow:hidden;margin-bottom:24px;}
        .dark-theme .progress-bar-container {background:#3A3A3C;}
        .progress-bar {height:100%;background:#34C759;border-radius:4px;transition:width 0.3s;}
        .timer-container {width:100%;display:flex;justify-content:center;align-items:center;margin-bottom:20px;}
        .timer {font-size:24px;font-weight:500;color:#FF9500;}
        .dark-theme .timer {color:#FF9F0A;}
        .option-buttons {width:100%;display:flex;flex-direction:column;gap:12px;}
        .option-button {width:100%;padding:16px;background:#F2F2F7;border:1px solid #C7C7CC;border-radius:10px;font-size:17px;font-weight:500;color:#000;text-align:center;cursor:pointer;transition:all 0.2s;}
        .dark-theme .option-button {background:#2C2C2E;border:1px solid #38383A;color:#fff;}
        .option-button:active {background:#E5E5EA;transform:scale(0.98);}
        .dark-theme .option-button:active {background:#3A3A3C;}
        .buttons-row {display:flex;justify-content:space-between;margin-top:16px;gap:12px;}
        .action-button {flex:1;padding:14px 20px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;text-align:center;}
        .primary-button {background:#007AFF;color:#fff;}
        .dark-theme .primary-button {background:#0A84FF;}
        .secondary-button {background:#F2F2F7;color:#007AFF;border:1px solid #C7C7CC;}
        .dark-theme .secondary-button {background:#2C2C2E;color:#0A84FF;border:1px solid #38383A;}
        .correct {background:#34C759!important;color:#fff!important;border-color:#34C759!important;}
        .dark-theme .correct {background:#30D158!important;border-color:#30D158!important;}
        .incorrect {background:#FF3B30!important;color:#fff!important;border-color:#FF3B30!important;}
        .dark-theme .incorrect {background:#FF453A!important;border-color:#FF453A!important;}
        .tab-bar {display:flex;background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid rgba(60,60,67,0.15);padding:8px 0;}
        .dark-theme .tab-bar {background:rgba(30,30,30,0.7);border-top:1px solid rgba(255,255,255,0.15);}
        .tab {flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0;cursor:pointer;}
        .tab-icon {font-size:24px;margin-bottom:4px;color:#8E8E93;}
        .tab-label {font-size:10px;color:#8E8E93;}
        .tab.active .tab-icon, .tab.active .tab-label {color:#007AFF;}
        .dark-theme .tab.active .tab-icon, .dark-theme .tab.active .tab-label {color:#0A84FF;}
        .modal {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;visibility:hidden;transition:opacity 0.3s,visibility 0.3s;}
        .modal.show {opacity:1;visibility:visible;}
        .modal-content {background:#fff;border-radius:14px;width:85%;max-width:340px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.2);}
        .dark-theme .modal-content {background:#2C2C2E;box-shadow:0 4px 16px rgba(0,0,0,0.5);}
        .modal-title {font-size:17px;font-weight:600;margin-bottom:16px;text-align:center;}
        .modal-buttons {display:flex;justify-content:space-between;margin-top:20px;}
        @keyframes slide-up {0%{transform:translateY(20px);opacity:0;}100%{transform:translateY(0);opacity:1;}}
        .screen {display:none;height:100%;flex-direction:column;flex:1;}
        .screen.active {display:flex;}
        .word-list {display:flex;flex-direction:column;gap:12px;}
        .word-list-item {background:#fff;border-radius:10px;padding:16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 5px rgba(0,0,0,0.1);}
        .dark-theme .word-list-item {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
        .word-list-text {display:flex;flex-direction:column;}
        .word-list-item-title {font-size:17px;font-weight:500;margin-bottom:4px;}
        .word-list-item-subtitle {font-size:14px;color:#8E8E93;}
        .checkmark {color:#34C759;font-size:20px;}
        .stats-card {background:#fff;border-radius:10px;padding:20px;margin-bottom:16px;box-shadow:0 1px 5px rgba(0,0,0,0.1);}
        .dark-theme .stats-card {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
        .stats-title {font-size:17px;font-weight:600;margin-bottom:16px;}
        .stats-row {display:flex;justify-content:space-between;margin-bottom:12px;}
        .stats-label {font-size:15px;color:#8E8E93;}
        .stats-value {font-size:15px;font-weight:500;}
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .sync-overlay {
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.8);
            display:flex;
            justify-content:center;
            align-items:center;
            z-index:1000;
            color:white;
            font-size:18px;
        }
        
        @media (prefers-color-scheme: dark) {
            body {background:#000;color:#fff;}
            .header {background:rgba(30,30,30,0.7);border-bottom:1px solid rgba(255,255,255,0.15);}
            .header-button {color:#0A84FF;}
            .word-card {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
            .word {color:#fff;}
            .progress-bar-container {background:#3A3A3C;}
            .timer {color:#FF9F0A;}
            .option-button {background:#2C2C2E;border:1px solid #38383A;color:#fff;}
            .option-button:active {background:#3A3A3C;}
            .primary-button {background:#0A84FF;}
            .secondary-button {background:#2C2C2E;color:#0A84FF;border:1px solid #38383A;}
            .correct {background:#30D158!important;border-color:#30D158!important;}
            .incorrect {background:#FF453A!important;border-color:#FF453A!important;}
            .tab-bar {background:rgba(30,30,30,0.7);border-top:1px solid rgba(255,255,255,0.15);}
            .tab.active .tab-icon,.tab.active .tab-label{color:#0A84FF;}
            .modal-content {background:#2C2C2E;box-shadow:0 4px 16px rgba(0,0,0,0.5);}
            .word-list-item {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
            .stats-card {background:#1c1c1e;box-shadow:0 1px 5px rgba(255,255,255,0.05);}
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="sync-overlay" class="sync-overlay">
        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –∏–∑—É—á–µ–Ω–∏—è —Å–ª–æ–≤ -->
    <div id="learn-screen" class="screen active">
        <div class="header">
            <button class="header-button" id="menu-button">–ú–µ–Ω—é</button>
            <h1>–ò–∑—É—á–µ–Ω–∏–µ —Å–ª–æ–≤</h1>
            <button class="header-button" id="stats-button">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>
        
        <div class="container">
            <div class="word-card">
                <div class="word" id="current-word">der Tisch</div>
                <div class="progress-info">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="word-progress">125</span>/500 –±–∞–ª–ª–æ–≤</div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 25%"></div>
                </div>
                
                <div class="timer-container">
                    <div class="timer" id="timer">10</div>
                </div>
                
                <div class="option-buttons" id="options-container">
                    <button class="option-button" data-correct="true">—Å—Ç–æ–ª</button>
                    <button class="option-button">—Å—Ç—É–ª</button>
                    <button class="option-button">–¥–∏–≤–∞–Ω</button>
                    <button class="option-button">–ø–æ–ª–∫–∞</button>
                </div>
                
                <div class="buttons-row">
                    <button class="action-button secondary-button" id="known-button">–Ø –∑–Ω–∞—é —ç—Ç–æ —Å–ª–æ–≤–æ</button>
                </div>
            </div>
        </div>
        
        <div class="tab-bar">
            <div class="tab active" data-screen="learn-screen">
                <div class="tab-icon">üìö</div>
                <div class="tab-label">–£—á–∏—Ç—å</div>
            </div>
            <div class="tab" data-screen="known-screen">
                <div class="tab-icon">üß†</div>
                <div class="tab-label">–í—ã—É—á–µ–Ω–Ω—ã–µ</div>
            </div>
            <div class="tab" data-screen="errors-screen">
                <div class="tab-icon">‚ùå</div>
                <div class="tab-label">–û—à–∏–±–∫–∏</div>
            </div>
            <div class="tab" data-screen="stats-screen">
                <div class="tab-icon">üìä</div>
                <div class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –≤—ã—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ -->
    <div id="known-screen" class="screen">
        <div class="header">
            <button class="header-button" id="back-button-known">–ù–∞–∑–∞–¥</button>
            <h1>–í—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</h1>
            <div style="width: 50px;"></div>
        </div>
        
        <div class="container">
            <div class="word-list" id="known-words-list">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —Å–ª–æ–≤–∞ -->
            </div>
        </div>
        
        <div class="tab-bar">
            <div class="tab" data-screen="learn-screen">
                <div class="tab-icon">üìö</div>
                <div class="tab-label">–£—á–∏—Ç—å</div>
            </div>
            <div class="tab active" data-screen="known-screen">
                <div class="tab-icon">üß†</div>
                <div class="tab-label">–í—ã—É—á–µ–Ω–Ω—ã–µ</div>
            </div>
            <div class="tab" data-screen="errors-screen">
                <div class="tab-icon">‚ùå</div>
                <div class="tab-label">–û—à–∏–±–∫–∏</div>
            </div>
            <div class="tab" data-screen="stats-screen">
                <div class="tab-icon">üìä</div>
                <div class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏ -->
    <div id="errors-screen" class="screen">
        <div class="header">
            <button class="header-button" id="back-button-errors">–ù–∞–∑–∞–¥</button>
            <h1>–°–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏</h1>
            <div style="width: 50px;"></div>
        </div>
        
        <div class="container">
            <div class="word-list" id="error-words-list">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —Å–ª–æ–≤–∞ -->
            </div>
            
            <button class="action-button primary-button" id="repeat-all-button" style="margin-top: 16px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Å–µ —Å–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏</button>
        </div>
        
        <div class="tab-bar">
            <div class="tab" data-screen="learn-screen">
                <div class="tab-icon">üìö</div>
                <div class="tab-label">–£—á–∏—Ç—å</div>
            </div>
            <div class="tab" data-screen="known-screen">
                <div class="tab-icon">üß†</div>
                <div class="tab-label">–í—ã—É—á–µ–Ω–Ω—ã–µ</div>
            </div>
            <div class="tab active" data-screen="errors-screen">
                <div class="tab-icon">‚ùå</div>
                <div class="tab-label">–û—à–∏–±–∫–∏</div>
            </div>
            <div class="tab" data-screen="stats-screen">
                <div class="tab-icon">üìä</div>
                <div class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="stats-screen" class="screen">
        <div class="header">
            <button class="header-button" id="back-button-stats">–ù–∞–∑–∞–¥</button>
            <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
            <div style="width: 50px;"></div>
        </div>
        
        <div class="container">
            <div class="stats-card">
                <div class="stats-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                
                <div class="stats-row">
                    <div class="stats-label">–í—ã—É—á–µ–Ω–æ —Å–ª–æ–≤:</div>
                    <div class="stats-value" id="total-known-words">0</div>
                </div>
                
                <div class="stats-row">
                    <div class="stats-label">–°–ª–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ:</div>
                    <div class="stats-value" id="in-progress-words">0</div>
                </div>
                
                <div class="stats-row">
                    <div class="stats-label">–°–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏:</div>
                    <div class="stats-value" id="error-words-count">0</div>
                </div>
                
                <div class="stats-row">
                    <div class="stats-label">–í—Å–µ–≥–æ –Ω–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤:</div>
                    <div class="stats-value" id="total-score">0</div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="stats-title">–¢–æ–ø —Å–ª–æ–≤</div>
                
                <div class="word-list" id="top-words-list">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º—ã–µ —Å–ª–æ–≤–∞ -->
                </div>
            </div>
        </div>
        
        <div class="tab-bar">
            <div class="tab" data-screen="learn-screen">
                <div class="tab-icon">üìö</div>
                <div class="tab-label">–£—á–∏—Ç—å</div>
            </div>
            <div class="tab" data-screen="known-screen">
                <div class="tab-icon">üß†</div>
                <div class="tab-label">–í—ã—É—á–µ–Ω–Ω—ã–µ</div>
            </div>
            <div class="tab" data-screen="errors-screen">
                <div class="tab-icon">‚ùå</div>
                <div class="tab-label">–û—à–∏–±–∫–∏</div>
            </div>
            <div class="tab active" data-screen="stats-screen">
                <div class="tab-icon">üìä</div>
                <div class="tab-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="result-title">–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</div>
            <div id="result-message">–í—ã –ø–æ–ª—É—á–∏–ª–∏ 85 –±–∞–ª–ª–æ–≤.</div>
            <div class="modal-buttons">
                <button class="action-button primary-button" id="continue-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
    // --- Telegram WebApp –∏ —Ç–µ–º–∞ ---
    let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : {colorScheme:'light',expand:()=>{},sendData:()=>{}};
    tg.expand && tg.expand();
    if (tg.colorScheme === 'dark') document.body.classList.add('dark-theme');

    // --- –î–∞–Ω–Ω—ã–µ ---
    let words = [];
    let currentWordIndex = 0;
    let knownWords = [];
    let errorWords = [];
    let timerInterval;
    let timeLeft = 10;

    // --- Supabase –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ---
    const SUPABASE_URL = "https://oyppivnywdzbdqmugwfp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cHBpdm55d2R6YmRxbXVnd2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3MjE3NzUsImV4cCI6MjA2MjI5Nzc3NX0.GspH-GCes-8d001Ox8oRao2_5jOHy1wEYlGrel5WHMI";
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // –ü–æ–ª—É—á–∏—Ç—å userId –∏–∑ Telegram WebApp –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π
    let userId = null;
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        userId = tg.initDataUnsafe.user.id.toString();
    } else {
        userId = localStorage.getItem('dzhus_userid') || ('user_' + Math.random().toString(36).substr(2, 9));
        localStorage.setItem('dzhus_userid', userId);
    }

    // --- –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ Supabase ---
    async function saveProgress(userId, word, progress, known = false, isError = false) {
        try {
            const progressData = {
                user_id: userId,
                word: word,
                progress: progress,
                known: known,
                is_error: isError,
                updated_at: new Date().toISOString()
            };

            const { data, error } = await supabaseClient
                .from('progress')
                .upsert([progressData], { onConflict: 'user_id,word' });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                return false;
            } else {
                console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data);
                return true;
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
            return false;
        }
    }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑ Supabase ---
    async function loadProgress(userId) {
        try {
            const { data, error } = await supabaseClient
                .from('progress')
                .select('*')
                .eq('user_id', userId);
                
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                return [];
            }
            return data || [];
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
            return [];
        }
    }

    // --- –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º ---
    async function syncWithBot(progressData) {
        if (tg.sendData) {
            const syncData = {
                type: 'progress_sync',
                progress: progressData
            };
            tg.sendData(JSON.stringify(syncData));
        }
    }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
    async function initializeApp() {
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('sync-overlay').style.display = 'flex';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞
            await loadWords();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const progressData = await loadProgress(userId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            updateLocalDataFromProgress(progressData);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('sync-overlay').style.display = 'none';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
            showCurrentWord();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            setInterval(async () => {
                const currentProgress = collectProgressData();
                await syncWithBot(currentProgress);
            }, 60000); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            document.getElementById('sync-overlay').innerHTML = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
        }
    }

    // --- –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
    function updateLocalDataFromProgress(progressData) {
        knownWords = [];
        errorWords = [];
        
        progressData.forEach(item => {
            const wordData = words.find(w => w.word === item.word);
            if (wordData) {
                wordData.progress = item.progress;
                
                if (item.known || item.progress >= 500) {
                    knownWords.push({
                        word: item.word,
                        progress: item.progress
                    });
                }
                
                if (item.is_error) {
                    errorWords.push({
                        word: item.word,
                        progress: item.progress
                    });
                }
            }
        });
    }

    // --- –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
    function collectProgressData() {
        const progressData = [];
        
        words.forEach(word => {
            if (word.progress > 0) {
                progressData.push({
                    word: word.word,
                    progress: word.progress,
                    known: knownWords.some(w => w.word === word.word),
                    is_error: errorWords.some(w => w.word === word.word)
                });
            }
        });
        
        return progressData;
    }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤ ---
    async function loadWords() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/djys0912/dzhussolingvobot/main/words_data.json');
            const data = await response.json();
            
            words = data.map(item => ({
                word: item['–°–ª–æ–≤–æ (DE)'],
                translation: item['–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç'],
                options: [
                    item['–ù–µ–≤–µ—Ä–Ω—ã–π 1'],
                    item['–ù–µ–≤–µ—Ä–Ω—ã–π 2'],
                    item['–ù–µ–≤–µ—Ä–Ω—ã–π 3']
                ],
                progress: 0
            }));
            
            console.log('–°–ª–æ–≤–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', words.length);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ª–æ–≤:', error);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
            words = [{
                word: "der Tisch",
                translation: "—Å—Ç–æ–ª",
                options: ["—Å—Ç—É–ª", "–¥–∏–≤–∞–Ω", "–ø–æ–ª–∫–∞"],
                progress: 0
            }];
        }
    }

    function showCurrentWord() {
        const filteredWords = words.filter(w => w.progress < 500);
        if (filteredWords.length === 0) {
            document.getElementById('current-word').textContent = '–í—Å–µ —Å–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã!';
            document.getElementById('word-progress').textContent = '500';
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('options-container').innerHTML = '';
            return;
        }
        
        currentWordIndex = currentWordIndex % filteredWords.length;
        const currentWord = filteredWords[currentWordIndex];
        
        document.getElementById('current-word').textContent = currentWord.word;
        document.getElementById('word-progress').textContent = currentWord.progress;
        document.getElementById('progress-bar').style.width = (currentWord.progress / 500 * 100) + '%';
        
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        const shuffledOptions = [...currentWord.options, currentWord.translation].sort(() => 0.5 - Math.random());
        shuffledOptions.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'option-button';
            btn.textContent = option;
            btn.dataset.correct = (option === currentWord.translation);
            btn.addEventListener('click', handleOptionClick);
            optionsContainer.appendChild(btn);
        });
        
        resetTimer();
    }

    async function handleOptionClick(e) {
        clearInterval(timerInterval);
        const selected = e.target;
        const isCorrect = selected.dataset.correct === 'true';
        const currentWord = words.find(w => w.word === document.getElementById('current-word').textContent);
        
        if (isCorrect) {
            selected.classList.add('correct');
            const earnedPoints = Math.floor(timeLeft * 10);
            currentWord.progress += earnedPoints;
            
            document.getElementById('word-progress').textContent = currentWord.progress;
            document.getElementById('progress-bar').style.width = (currentWord.progress / 500 * 100) + '%';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã—É—á–µ–Ω–æ –ª–∏ —Å–ª–æ–≤–æ
            const isKnown = currentWord.progress >= 500;
            if (isKnown && !knownWords.some(w => w.word === currentWord.word)) {
                knownWords.push({word: currentWord.word, progress: currentWord.progress});
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ Supabase
            await saveProgress(userId, currentWord.word, currentWord.progress, isKnown, false);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º
            const progressData = collectProgressData();
            await syncWithBot(progressData);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤—Å–µ –ª–∏ —Å–ª–æ–≤–∞ –≤—ã—É—á–µ–Ω—ã
            const remainingWords = words.filter(w => w.progress < 500);
            if (remainingWords.length === 0) {
                document.getElementById('result-title').textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                document.getElementById('result-message').textContent = '–í—ã –≤—ã—É—á–∏–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞!';
                document.getElementById('result-modal').classList.add('show');
                return;
            }
            
            document.getElementById('result-title').textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
            document.getElementById('result-message').textContent = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${earnedPoints} –±–∞–ª–ª–æ–≤. –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ${currentWord.progress}/500`;
        } else {
            selected.classList.add('incorrect');
            document.querySelectorAll('.option-button').forEach(btn=>{
                if (btn.dataset.correct === 'true') btn.classList.add('correct');
            });
            
            // –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –Ω–µ—Ç
            if (!errorWords.some(w => w.word === currentWord.word)) {
                errorWords.push({word: currentWord.word, progress: currentWord.progress});
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å —Ñ–ª–∞–≥–æ–º –æ—à–∏–±–∫–∏
            await saveProgress(userId, currentWord.word, currentWord.progress, false, true);
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º
            const progressData = collectProgressData();
            await syncWithBot(progressData);
            
            document.getElementById('result-title').textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
            document.getElementById('result-message').textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${currentWord.translation}`;
        }
        
        document.querySelectorAll('.option-button').forEach(btn=>{
            btn.removeEventListener('click', handleOptionClick);
            btn.style.pointerEvents = 'none';
        });

        // –£–±–∏—Ä–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        setTimeout(goToNextWord, 1000);  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timeLeft = 10;
        document.getElementById('timer').textContent = timeLeft;
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                goToNextWord();
            }
        }, 1000);
    }

    function goToNextWord() {
        const availableWords = words.filter(w => w.progress < 500);
        if (availableWords.length === 0) return;
        currentWordIndex = (currentWordIndex + 1) % availableWords.length;
        showCurrentWord();
        document.getElementById('result-modal').classList.remove('show');
    }

    function showKnownWords() {
        const list = document.getElementById('known-words-list');
        list.innerHTML = '';
        if (knownWords.length === 0) {
            const empty = document.createElement('div');
            empty.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≤—ã—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤.';
            empty.style.textAlign = 'center';
            empty.style.padding = '20px';
            empty.style.color = '#8E8E93';
            list.appendChild(empty);
            return;
        }
        knownWords.forEach(word => {
            const item = document.createElement('div');
            item.className = 'word-list-item';
            const text = document.createElement('div');
            text.className = 'word-list-text';
            const title = document.createElement('div');
            title.className = 'word-list-item-title';
            title.textContent = word.word;
            const subtitle = document.createElement('div');
            subtitle.className = 'word-list-item-subtitle';
            subtitle.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${word.progress}/500 –±–∞–ª–ª–æ–≤`;
            text.appendChild(title);
            text.appendChild(subtitle);
            const check = document.createElement('div');
            check.className = 'checkmark';
            check.textContent = '‚úì';
            item.appendChild(text);
            item.appendChild(check);
            list.appendChild(item);
        });
    }

    function showErrorWords() {
        const list = document.getElementById('error-words-list');
        list.innerHTML = '';
        if (errorWords.length === 0) {
            const empty = document.createElement('div');
            empty.textContent = '–£ –≤–∞—Å –Ω–µ—Ç —Å–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏.';
            empty.style.textAlign = 'center';
            empty.style.padding = '20px';
            empty.style.color = '#8E8E93';
            list.appendChild(empty);
            return;
        }
        errorWords.forEach(word => {
            const item = document.createElement('div');
            item.className = 'word-list-item';
            const text = document.createElement('div');
            text.className = 'word-list-text';
            const title = document.createElement('div');
            title.className = 'word-list-item-title';
            title.textContent = word.word;
            const subtitle = document.createElement('div');
            subtitle.className = 'word-list-item-subtitle';
            subtitle.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${word.progress}/500 –±–∞–ª–ª–æ–≤`;
            text.appendChild(title);
            text.appendChild(subtitle);
            const repeatBtn = document.createElement('button');
            repeatBtn.className = 'action-button primary-button';
            repeatBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å';
            repeatBtn.style.padding = '8px 12px';
            repeatBtn.style.fontSize = '14px';
            repeatBtn.addEventListener('click', () => {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –æ–±—É—á–µ–Ω–∏—è –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞
                currentWordIndex = words.findIndex(w => w.word === word.word);
                switchScreen('learn-screen');
                showCurrentWord();
            });
            item.appendChild(text);
            item.appendChild(repeatBtn);
            list.appendChild(item);
        });
    }

    function updateStatistics() {
        document.getElementById('total-known-words').textContent = knownWords.length;
        document.getElementById('in-progress-words').textContent = words.filter(w => w.progress > 0 && w.progress < 500).length;
        document.getElementById('error-words-count').textContent = errorWords.length;
        const totalScore = words.reduce((total, word) => total + word.progress, 0);
        document.getElementById('total-score').textContent = totalScore;
        
        const topWordsList = document.getElementById('top-words-list');
        topWordsList.innerHTML = '';
        const allWords = [...words].sort((a, b) => b.progress - a.progress).slice(0, 5);
        allWords.forEach(word => {
            const item = document.createElement('div');
            item.className = 'word-list-item';
            const text = document.createElement('div');
            text.className = 'word-list-text';
            const title = document.createElement('div');
            title.className = 'word-list-item-title';
            title.textContent = word.word;
            const subtitle = document.createElement('div');
            subtitle.className = 'word-list-item-subtitle';
            subtitle.textContent = `${word.progress} –±–∞–ª–ª–æ–≤`;
            text.appendChild(title);
            text.appendChild(subtitle);
            item.appendChild(text);
            topWordsList.appendChild(item);
        });
    }

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ ---
    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∞–±—ã
        document.querySelectorAll('.tab-bar').forEach(bar => {
            bar.querySelectorAll('.tab').forEach(tab => {
                if (tab.dataset.screen === screenId) tab.classList.add('active');
                else tab.classList.remove('active');
            });
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
        if (screenId === 'known-screen') showKnownWords();
        if (screenId === 'errors-screen') showErrorWords();
        if (screenId === 'stats-screen') updateStatistics();
        if (screenId === 'learn-screen') showCurrentWord();
    }

    // --- –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    window.addEventListener('beforeunload', async () => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
        const progressData = collectProgressData();
        await syncWithBot(progressData);
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
    document.addEventListener('DOMContentLoaded', async function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        await initializeApp();
        
        // –¢–∞–±—ã
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                switchScreen(tab.dataset.screen);
            });
        });
        
        // –ö–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥
        document.getElementById('back-button-known').onclick = () => switchScreen('learn-screen');
        document.getElementById('back-button-errors').onclick = () => switchScreen('learn-screen');
        document.getElementById('back-button-stats').onclick = () => switchScreen('learn-screen');
        
        // –ú–µ–Ω—é –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ learn-screen
        document.getElementById('menu-button').onclick = () => alert('–ú–µ–Ω—é –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ');
        document.getElementById('stats-button').onclick = () => switchScreen('stats-screen');
        
        // –ö–Ω–æ–ø–∫–∞ "–Ø –∑–Ω–∞—é —ç—Ç–æ —Å–ª–æ–≤–æ"
        document.getElementById('known-button').onclick = async function() {
            const currentWordText = document.getElementById('current-word').textContent;
            const w = words.find(word => word.word === currentWordText);
            if (w && !knownWords.some(kw => kw.word === w.word)) {
                w.progress = Math.max(w.progress, 500); // –£—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å 500 –µ—Å–ª–∏ –º–µ–Ω—å—à–µ
                knownWords.push({word: w.word, progress: w.progress});
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ Supabase
                await saveProgress(userId, w.word, w.progress, true, false);
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –±–æ—Ç–æ–º
                const progressData = collectProgressData();
                await syncWithBot(progressData);
            }
            
            goToNextWord();
        };
        
        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –≤ –º–æ–¥–∞–ª–∫–µ
        document.getElementById('continue-button').onclick = function() {
            document.getElementById('result-modal').classList.remove('show');
            goToNextWord();
        };
        
        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Å–µ —Å–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏"
        const repeatAllBtn = document.getElementById('repeat-all-button');
        if (repeatAllBtn) repeatAllBtn.onclick = function() {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –æ–±—É—á–µ–Ω–∏—è –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å —Å–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏
            if (errorWords.length > 0) {
                currentWordIndex = words.findIndex(w => w.word === errorWords[0].word);
                switchScreen('learn-screen');
                showCurrentWord();
            }
        };
    });

    // –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if (tg.onEvent) {
        tg.onEvent('mainButtonClicked', async () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            const progressData = collectProgressData();
            await syncWithBot(progressData);
        });
        
        tg.onEvent('backButtonClicked', async () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            const progressData = collectProgressData();
            await syncWithBot(progressData);
        });
    }
    </script>
</body>
</html>